// pipeline {
//     agent any

//    tools {
//     jdk 'java17'
//     maven 'maven3'
//     nodejs 'node25'
// }


//     stages {
        
//         stage('Checkout') {
//             steps {
//                 git branch: 'main', url: 'https://github.com/pavanKumarKanthamraju/Employment-Details.git'
//             }
//         }
// //   stage('Build UI') {
// //             steps {
// //                 dir('frontend') { // adjust path if needed
// //                     sh 'npm install'
// //                     sh 'npm run build'
// //                 }
// //             }
// //         }
    
//         stage('Build') {
//             steps {
//                 sh 'mvn clean package -DskipTests'
//             }
//         }

//         stage('Run Jest Tests') {
//             steps {
//                 // Run Jest and generate coverage report
//                 sh 'npm install --save-dev jest-html-reporter'
//                 sh 'npx jest'
//             }
//             post {
//                 always {
//                     // Archive test results (optional, needs jest-junit setup)
//                     junit '**/test-results.xml'
                    
//                     // Archive coverage (optional)
//                     archiveArtifacts 'coverage/**/*'
//                 }
//             }
//         }

//         stage('Archive') {
//             steps {
//                 archiveArtifacts artifacts: '**/target/*.war', fingerprint: true
//             }
//         }
//     }

//     post {
//         success {
//             echo '‚úÖ Build succeeded!'
//         }
//         failure {
//             echo '‚ùå Build failed!'
//         }
//     }
// }
// pipeline {
//     agent any

//     tools {
//         jdk 'java17'
//         maven 'maven3'
//         nodejs 'node25'
//     }

//     stages {

//         stage('Checkout') {
//             steps {
//                 git branch: 'main', url: 'https://github.com/pavanKumarKanthamraju/Employment-Details.git'
//             }
//         }

//         stage('Build') {
//             steps {
//                 sh 'mvn clean package -DskipTests'
//             }
//         }

//         stage('Install Frontend Dependencies') {
//             steps {
//                 sh 'npm install'
//             }
//         }

//         stage('Run Jest Tests') {
//             steps {
//                 // Install reporters (optional if already in package.json)
//                 sh 'npm install --save-dev jest jest-junit jest-html-reporter'

//                 // Run Jest with coverage and reporters
//                 sh '''
//                 npx jest --coverage \
//                 --reporters=default \
//                 --reporters=jest-junit \
//                 --reporters=jest-html-reporter
//                 '''
//             }
//             post {
//                 always {
//                     // Create reports folder
//                     sh '''
//                     mkdir -p test-reports
//                     cp -r coverage test-reports/ || true
//                     cp jest-html-report.html test-reports/ || true
//                     cp junit.xml test-reports/ || true
//                     '''

//                     // Zip all reports
//                     sh 'zip -r test-reports.zip test-reports || true'

//                     // Publish test results
//                     junit 'junit.xml'

//                     // Archive all artifacts including the zip
//                     archiveArtifacts artifacts: 'test-reports.zip', fingerprint: true
//                     archiveArtifacts artifacts: 'test-reports/**/*', fingerprint: true
//                 }
//             }
//         }

//         // Optional WAR packaging (if backend exists)
//         // stage('Archive WAR') {
//         //     steps {
//         //         archiveArtifacts artifacts: '**/target/*.war', fingerprint: true
//         //     }
//         // }
//     }

//     post {
//         success {
//             echo '‚úÖ Build succeeded!'
//             echo 'üì¶ Download full test report from: Build ‚Üí Artifacts ‚Üí test-reports.zip'
//         }
//         failure {
//             echo '‚ùå Build failed!'
//         }
//     }
// }

pipeline {
    agent any

    tools {
        jdk 'java17'
        maven 'maven3'
        nodejs 'node25'
    }

    environment {
        // TEST_PATH = '/Users/pavank_500328/Downloads/EmployeeManagementDetails'
         TEST_PATH = "${WORKSPACE}"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/pavanKumarKanthamraju/Employment-Details.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${env.TEST_PATH}") {
                    sh '''
                    echo "üì¶ Installing dependencies..."
                    npm install
                    '''
                }
            }
        }

        stage('Install wm-unit-test-generator') {
            steps {
                // ‚ö†Ô∏è This will fail if your registry doesn't have this package
                // You can remove this if using local `npm link` instead
                sh 'npm install -g wm-unit-test-generator || true'
            }
        }

        stage('Link wm-unit-test-generator') {
            steps {
                script {
                    sh '''
                    echo "üîó Linking local wm-unit-test-generator CLI..."
                    cd /Users/pavank_500328/Downloads/llm-test-gen
                    npm link
                    '''
                }
            }
        }

           stage('Run Unit Tests') {
    steps {
        dir("${env.TEST_PATH}") {
            sh '''
            echo "üß™ Running unit tests via wm-ut-gen..."
            npm install --save-dev jest-junit 
            wm-ut-gen run-tests --path=${TEST_PATH} || true

            echo "‚úÖ Checking for test report and coverage..."
            if [ -f "utreports/index.html" ]; then
              echo "‚úÖ Found test report at utreports/index.html"
            else
              echo "‚ö†Ô∏è Test report not found in utreports/"
            fi

            if [ -d "coverage" ]; then
              echo "‚úÖ Found coverage folder."
            else
              echo "‚ö†Ô∏è No coverage folder found."
            fi
            '''
        }
    }

    post {
    always {
        echo "üìä Archiving reports..."
        dir("${env.TEST_PATH}") {
            script {
                def htmlReport = "utreports/index.html"
                def coverageDir = "coverage"

                

                if (fileExists(htmlReport)) {
                    echo "‚úÖ Found test report at ${htmlReport}"
                    archiveArtifacts artifacts: 'utreports/**/*', fingerprint: true
                } else {
                    echo "‚ö†Ô∏è No test report found in ${env.TEST_PATH}/utreports"
                }

                if (fileExists(coverageDir)) {
                    echo "‚úÖ Found coverage report directory"
                    archiveArtifacts artifacts: 'coverage/**/*', fingerprint: true
                } else {
                    echo "‚ö†Ô∏è No coverage folder found in ${env.TEST_PATH}"
                }

                // Add report to Jenkins UI
                publishHTML(target: [
                    allowMissing: true,
                    keepAll: true,
                    alwaysLinkToLastBuild: true,
                    reportDir: 'utreports',
                    reportFiles: 'index.html',
                    reportName: 'üß™ Unit Test Report'
                ])

                // Publish JUnit XML to Jenkins test results
                    if (fileExists('utreports/junit.xml')) {
                        junit 'utreports/junit.xml'
                    }
            }
        }
    }
}

}
stage('Check Coverage Drop') {
            steps {
                dir("${env.TEST_PATH}") {
                    script {
                        sh 'node compareCoverage.js'
                    }
                }
            }
        }
    

    


        // stage('Package Build') {
        //     steps {
        //         sh '''
        //         echo "üèóÔ∏è Packaging Maven project..."
        //         mvn clean package -DskipTests
        //         '''
        //     }
        // }

        // stage('Archive WAR') {
        //     steps {
        //         archiveArtifacts artifacts: '**/target/*.war', fingerprint: true
        //     }
        // }
    }

    post {
        success {
            echo '‚úÖ Build and Tests Succeeded!'
        }
        failure {
            echo '‚ùå Build or Tests Failed!'
        }
    }
}



