pipeline {
    agent any

    tools {
        jdk 'java17'
        maven 'maven3'
        nodejs 'node20'
    }

    environment {
        TEST_PATH = "${WORKSPACE}"
        RECIPIENTS = 'pavan.kumar@wavemaker.com'
        COVERAGE_DROP = false
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs() 
                git branch: 'main', url: 'https://github.com/pavanKumarKanthamraju/Employment-Details.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${env.TEST_PATH}") {
                    sh 'npm install'
                }
            }
        }
 stage('Generate Unit Tests') {
    steps {
        // Ensure Jest environment package exists (for jsdom)
        sh '''
                echo "üì¶ Installing Jest dependencies..."
                npm install --registry=https://registry.npmjs.org/ --save-dev jest-environment-jsdom jest-junit jest-html-reporter acorn acorn-walk
            '''
        echo "üß† Running local CLI from Downloads folder..."
        sh '''
            set -e
            cd /Users/pavank_500328/Downloads/llm-test-gen
            npm install --registry=https://registry.npmjs.org/

            echo "üß™ Generating test files in manual mode..."
            yes 1 | node /Users/pavank_500328/Downloads/llm-test-gen/bin/cli.js generate --path=${TEST_PATH}
        '''
    }
}

        stage('Run Unit Tests') {
            steps {
                dir("${env.TEST_PATH}") {

                       
   

                    sh '''
                        npm install --registry=https://registry.npmjs.org/ --save-dev jest-junit
               echo "üß™ Running tests using local CLI..."
yes 1 | node /Users/pavank_500328/Downloads/llm-test-gen/bin/cli.js run-tests --path=${TEST_PATH} || true

                    '''
                }
            }

            post {
                always {
                    dir("${env.TEST_PATH}") {
                        script {
                            // Archive HTML report
                            if (fileExists('utreports/index.html')) {
                                archiveArtifacts artifacts: 'utreports/**/*', fingerprint: true
                            }

                            // Archive coverage
                            if (fileExists('coverage')) {
                                archiveArtifacts artifacts: 'coverage/**/*', fingerprint: true
                            }

                            // Publish JUnit results
                            if (fileExists('utreports/junit.xml')) {
                                junit 'utreports/junit.xml'
                                 publishHTML([
                allowMissing: false,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'utreports',
                reportFiles: 'index.html',
                reportName: 'Unit Test Coverage Report'
            ])
                            }
                        }
                    }
                }
            }
        }

        stage('Check Coverage Drop') {
            steps {
                dir("${env.TEST_PATH}") {
                    script {
                        // Run your coverage comparison script
                        def status = sh(script: 'node compareCoverage.js', returnStatus: true)
                        if (status != 0) {
                            env.COVERAGE_DROP = true
                            echo "‚ùå Coverage drop detected!"
                        } else {
                            echo "‚úÖ Coverage check passed."
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                // Determine final build status
                def buildStatus = currentBuild.currentResult
                def coverageStatus = env.COVERAGE_DROP.toBoolean() ? "‚ö†Ô∏è Coverage Dropped!" : "‚úÖ Coverage OK"

                // Compose consolidated email
                def emailBody =  """\
<html>
  <body style="font-family: Arial, sans-serif;">
    <h3>üîî Build Summary</h3>
    <p><b>Build Status:</b> ${buildStatus}</p>
    <p><b>Job:</b> ${env.JOB_NAME} #${env.BUILD_NUMBER}</p>
    <p><b>Jenkins URL:</b> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
    <p><b>üß™ Unit Test Coverage Report:</b> <a href="${env.BUILD_URL}/artifact/utreports/index.html">View Report</a></p>
    <p><b>Coverage Status:</b> ${coverageStatus}</p>
    <br>
    <p>Thanks,<br>Jenkins</p>
  </body>
</html>
"""

                // Send consolidated email
                emailext(
                   to: "${env.RECIPIENTS}",
                subject: "Build ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${buildStatus}",
                    body: emailBody,
                    mimeType: 'text/plain',
                    from: "ps-tools@wavemaker.com"
                )
            }
        }

        success {
            echo '‚úÖ Build and Tests Succeeded!'
        }

        failure {
            echo '‚ùå Build or Tests Failed!'
        }
    }
}
