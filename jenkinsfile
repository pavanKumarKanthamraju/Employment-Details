pipeline {
    agent any

    tools {
        jdk 'java17'
        maven 'maven3'
        nodejs 'node25'
    }

    environment {
        TEST_PATH = "${WORKSPACE}"
        RECIPIENTS = 'pavan.kumar@wavemaker.com'
        COVERAGE_DROP = false
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/pavanKumarKanthamraju/Employment-Details.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${env.TEST_PATH}") {
                    sh 'npm install'
                }
            }
        }

        stage('Run Unit Tests') {
            steps {
                dir("${env.TEST_PATH}") {
                    sh '''
                        npm install --registry=https://registry.npmjs.org/ --save-dev jest-junit
                        wm-ut-gen run-tests --path=${TEST_PATH} || true
                    '''
                }
            }

            post {
                always {
                    dir("${env.TEST_PATH}") {
                        script {
                            // Archive HTML report
                            if (fileExists('utreports/index.html')) {
                                archiveArtifacts artifacts: 'utreports/**/*', fingerprint: true
                                publishHTML(target: [
                                    allowMissing: true,
                                    keepAll: true,
                                    alwaysLinkToLastBuild: true,
                                    reportDir: 'utreports',
                                    reportFiles: 'index.html',
                                    reportName: 'üß™ Unit Test Report'
                                ])
                            }

                            // Archive coverage
                            if (fileExists('coverage')) {
                                archiveArtifacts artifacts: 'coverage/**/*', fingerprint: true
                            }

                            // Publish JUnit results
                            if (fileExists('utreports/junit.xml')) {
                                junit 'utreports/junit.xml'
                            }
                        }
                    }
                }
            }
        }

        stage('Check Coverage Drop') {
            steps {
                dir("${env.TEST_PATH}") {
                    script {
                        // Run your coverage comparison script
                        def status = sh(script: 'node compareCoverage.js', returnStatus: true)
                        if (status != 0) {
                            env.COVERAGE_DROP = true
                            echo "‚ùå Coverage drop detected!"
                        } else {
                            echo "‚úÖ Coverage check passed."
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                // Determine final build status
                def buildStatus = currentBuild.currentResult
                def coverageStatus = env.COVERAGE_DROP.toBoolean() ? "‚ö†Ô∏è Coverage Dropped!" : "‚úÖ Coverage OK"

                // Compose consolidated email
                def emailBody = """\
Hello Team,

Build Status: ${buildStatus}
Job: ${env.JOB_NAME} #${env.BUILD_NUMBER}
URL: ${env.BUILD_URL}

Unit Test Report: ${env.BUILD_URL}testReport
Coverage Report: ${env.BUILD_URL}artifact/coverage/index.html
Coverage Status: ${coverageStatus}

Thanks,
Jenkins
"""

                // Send consolidated email
                emailext(
                    to: "${env.RECIPIENTS}",
                    subject: "Build ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${buildStatus}",
                    body: emailBody,
                    mimeType: 'text/plain'
                )
            }
        }

        success {
            echo '‚úÖ Build and Tests Succeeded!'
        }

        failure {
            echo '‚ùå Build or Tests Failed!'
        }
    }
}
